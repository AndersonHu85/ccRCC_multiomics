library(dplyr)
library(ggplot2)
library(cowplot)
library(harmony)
library(Seurat)
library(ggsci)
library(Rcpp)
library(RColorBrewer)
options(stringsAsFactors = F)

normal@meta.data$nUMI <- normal@meta.data$nCount_RNA
normal@meta.data$nGene <- normal@meta.data$nFeature_RNA


mito.genes <- grep(
  pattern = "^MT-",
  x = rownames(x = normal@assays$RNA@data),
  value = TRUE)

percent.mito <- Matrix::colSums(normal@assays$RNA@counts[mito.genes, ]) / Matrix::colSums(normal@assays$RNA@counts)

normal <- AddMetaData(
  object = normal,
  metadata = percent.mito,
  col.name = "percent.mito")
VlnPlot(normal, c("nUMI","nGene","percent.mito"), group.by = "sample",pt.size = 0)

normal <- subset(normal, subset = percent.mito < 0.05)
normal <- subset(normal, subset = n_genes > 500)
normal <- subset(normal, subset = nUMI > 1000)

normal <- NormalizeData(normal)

normal <- FindVariableFeatures(normal, nfeatures = 3000)
VariableFeaturePlot(normal)
normal <- ScaleData(normal, verbose = T)
normal <- RunPCA(normal, npcs = 50, verbose = FALSE)
PCAPlot(normal)
ElbowPlot(normal, ndims = 50)
normal <- RunHarmony(normal, c("sample"))
normal <- FindNeighbors(normal, reduction = "harmony", dims = 1:50, do.plot = T)
normal <- FindClusters(normal, resolution = 1)

normal <- RunUMAP(normal, reduction = "harmony", dims = 1:50, n.components = 2)

p1 <- DimPlot(normal, reduction = "umap", group.by = "sample",cols = celltype, label = TRUE)+ NoLegend()
p2 <- DimPlot(normal, reduction = "umap", group.by = "RNA_snn_res.1", cols = celltype, pt.size = 0.4,
              label = TRUE,raster = F) + NoLegend()
plot_grid(p1,p2)

normal <- CellCycleScoring(normal, g2m.features = cc.genes$g2m.genes,
                               s.features = cc.genes$s.genes)

celltype <- c(brewer.pal(11,"Set3")[c(1,3:8,10:11)],pal_npg(alpha = 0.7)(9),
              brewer.pal(11,"Paired")[11:1],brewer.pal(8,"Set1")[8:1],
              brewer.pal(8,"Set2"))#[13:1]

DimPlot(normal, reduction = "umap", group.by = "celltype2", label = T, repel = TRUE,
        cols = celltype, pt.size =0.4,
)
